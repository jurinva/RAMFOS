;----------------------------------------------------------------------------
; RAMFOS
; Автоповтор клавиатуры и эхопечать (обертка над сканирование клавиатуры)
;
; 2013-11-01 Дизассемблировано vinxru
;----------------------------------------------------------------------------

#if FAST_PRINT==0
keyScanWhilePrint:
		; Обработка клавиш во время вывода и эхопечать

		; Если v_cursorY=8 или 248, выходим 
		mov	a, e
		cpi	8
		rz
		cpi	248
		rz

		; Если включен эхо режим на принтер
		lda	v_printerEcho
		cpi	0D2h
		jz	doPrinterEcho
#endif
		
keyCheck:
		; Какой то флаг
		lda	v_key2
		ora	a
		rnz

		; Что то считаем
		push	h
		push	d
		 lhld	v_key0
		 xchg
		 lhld	v_key1
		 call	sub_CEE2
		 shld	v_key1	; Нажатая клавиша в L
		 xchg
		 shld	v_key0
		 sta	v_key2

		; pop d
		; pop h
		; ora a
		; ret
		jmp	popa_ora_a_ret

; ---------------------------------------------------------------------------

sub_CEE2:	; Получить код нажатой клавиши
		call	keyScan

		; Если нажатая клавиша не L
		cmp	l
		mov	l, a
		jnz	loc_CF01

		; Если клавиша не была нажата, выходим с кодом 0
		inr	a
		rz

		; Уменьшаем DE, и если он не нулевой, выходим с кодом 0
		dcx	d
		mov	a, d
		ora	e
		mvi	a, 0
		rnz

		; Звуковой сигнал
		call	keySound

		; Инициализируем счетчик
		lxi	d, 17Ch

		; Если H=0, выходим с кодом 0FFh
		dcr	h
		mvi	a, 0FFh
		rz

		; Возвращаем H
		inr	h

		; Инициализируем счетчик
		lxi	d, 1Ch
		ret
; ---------------------------------------------------------------------------

loc_CF01:	; Записываем H=1
		mvi	h, 1

		; Выходим с кодом 0
		xra	a        	

		; Инициализируем счетчик
		lxi	d, 30h
		ret

; ---------------------------------------------------------------------------
